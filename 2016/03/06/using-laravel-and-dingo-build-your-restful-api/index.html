<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="laravel,php,auth,dingo,jwt,RESTful," />










<meta name="description" content="dingo api是由澳洲开发者Jason Lewis为laravel及lumen框架更好地实现RESTful接口而量身打造的第三方库，最近也尝试用laravel+dingo写了一个线上项目，博主不才，只能写篇博文抛砖引玉。">
<meta name="keywords" content="laravel,php,auth,dingo,jwt,RESTful">
<meta property="og:type" content="article">
<meta property="og:title" content="使用laravel+dingo打造你的RESTful接口">
<meta property="og:url" content="https://coder-wen.github.io/2016/03/06/using-laravel-and-dingo-build-your-restful-api/index.html">
<meta property="og:site_name" content="coderwen的踩坑日记">
<meta property="og:description" content="dingo api是由澳洲开发者Jason Lewis为laravel及lumen框架更好地实现RESTful接口而量身打造的第三方库，最近也尝试用laravel+dingo写了一个线上项目，博主不才，只能写篇博文抛砖引玉。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/hello-api-test.jpg">
<meta property="og:image" content="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/register1.jpg">
<meta property="og:image" content="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/register2.jpg">
<meta property="og:image" content="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/Oauth2.0workflow.jpg">
<meta property="og:image" content="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/jwt-diagram.png">
<meta property="og:updated_time" content="2018-02-28T09:45:55.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用laravel+dingo打造你的RESTful接口">
<meta name="twitter:description" content="dingo api是由澳洲开发者Jason Lewis为laravel及lumen框架更好地实现RESTful接口而量身打造的第三方库，最近也尝试用laravel+dingo写了一个线上项目，博主不才，只能写篇博文抛砖引玉。">
<meta name="twitter:image" content="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/hello-api-test.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://coder-wen.github.io/2016/03/06/using-laravel-and-dingo-build-your-restful-api/"/>





  <title>使用laravel+dingo打造你的RESTful接口 | coderwen的踩坑日记</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">coderwen的踩坑日记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">闷声学技术，比西方记者快，比华莱士高</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://coder-wen.github.io/2016/03/06/using-laravel-and-dingo-build-your-restful-api/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="coderwen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="coderwen的踩坑日记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">使用laravel+dingo打造你的RESTful接口</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-06T22:24:15+08:00">
                2016-03-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/laravel/" itemprop="url" rel="index">
                    <span itemprop="name">laravel</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/laravel/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/laravel/linux/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="https://github.com/dingo/api" target="_blank" rel="noopener">dingo api</a>是由澳洲开发者<a href="http://jasonlewis.me/about" target="_blank" rel="noopener">Jason Lewis</a>为laravel及lumen框架更好地实现RESTful接口而量身打造的第三方库，最近也尝试用laravel+dingo写了一个线上项目，博主不才，只能写篇博文抛砖引玉。<br><a id="more"></a><br>安装配置什么的<a href="https://github.com/dingo/api/wiki" target="_blank" rel="noopener">dingo wiki</a>都说得很清楚，方便英文不好的同学我还是从头开写</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>为了演示我新建了个laravel项目，首先在 composer.json里面加入</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">"require": &#123;</span><br><span class="line">    "php": "&gt;=5.5.9",</span><br><span class="line">    "laravel/framework": "5.2.*",</span><br><span class="line">    "dingo/api": "1.0.*@dev"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>接着我们<br><code>composer update</code></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>如果你使用的laravel</p>
<p>在config/app.php中添加上dingo的ServiceProvider</p>
<p>接着我们通过artisan命令将dingo中的配置文件发布到config目录下<br><code>php artisan vendor:publish --provider=&quot;Dingo\Api\Provider\LaravelServiceProvider&quot;</code><br>现在config目录下多了一个api.php配置文件，之后的一些配置会用到</p>
<p>如果你使用的lumen</p>
<p>在bootstrap/app.php下注册dingo的ServiceProvider<br><code>$app-&gt;register(Dingo\Api\Provider\LumenServiceProvider::class);</code><br>接着我们还需要配置一些其他的环境变量</p>
<p>我们可以在.env或刚才生成的api.php文件中添加或修改如下选项</p>
<ul>
<li><code>API_SUBTYPE=dingo</code><br>  API_SUBTYPE 你接口项目的名字，我随便设成dingo，<strong>注意，值需要全部小写</strong><br>  对于一个接口地址可以是www.homestead.app/api 这种二级目录的形式</li>
<li><code>API_PREFIX=api</code><br>  也可以是二级域名api.homestead.app的形式，二选一</li>
<li><code>API_DOMAIN=api.homestead.com</code><br>  接着是api版本号，才开始都是v1</li>
<li><code>API_VERSION=v1</code><br>  API_NAME 主要是为了dingo自带的blueprint生存api文档时的标题用的，可以不设置，如果设置一定<strong>加双引号</strong></li>
<li><code>API_NAME=&quot;My Dingo Demo&quot;</code><br>  严格模式开启后，顾名思义严格检验http header<br>  如果无效则抛出<code>Symfony\Component\HttpKernel\Exception\BadRequestHttpException</code>异常，这个异常需要你自己去handle</li>
<li><code>API_STRICT=false</code><br>  默认传输格式json</li>
<li><code>API_DEFAULT_FORMAT=json</code><br>  debug模式，开发时暂时设为true</li>
<li><code>API_DEBUG=true</code><br>  至此基本配置已经完成，如果就这样翻译wiki就太没意思了</li>
</ul>
<h2 id="设计RESTful接口"><a href="#设计RESTful接口" class="headerlink" title="设计RESTful接口"></a>设计RESTful接口</h2><blockquote>
<p>现在我们着手设计一个类似秘密的restful接口，实践才是硬道理！</p>
</blockquote>
<p>接口需要完成如下功能：</p>
<ul>
<li><p>注册，</p>
</li>
<li><p>鉴权(restful接口里面已经不存在登录的概念)，</p>
</li>
<li><p>获取用户信息，</p>
</li>
<li><p>发布秘密，</p>
</li>
<li><p>获取秘密列表，</p>
</li>
<li><p>获取秘密评论，</p>
</li>
<li><p>评论秘密，</p>
</li>
<li><p>删除秘密，</p>
</li>
</ul>
<p>暂时就考虑如上接口，毕竟是个玩具应用</p>
<hr>
<p>API节点初步设计如下</p>
<ul>
<li><p>注册</p>
<blockquote>
<p>POST /user/{user_name}/register</p>
</blockquote>
</li>
<li><p>鉴权</p>
<blockquote>
<p>POST  /user/{user_name}/auth</p>
</blockquote>
</li>
<li><p>获取用户信息</p>
<blockquote>
<p>GET    /user/{user_name}</p>
</blockquote>
</li>
<li><p>发布秘密</p>
<blockquote>
<p>POST /user/{user_name}/secrets</p>
</blockquote>
</li>
<li><p>删除秘密</p>
<blockquote>
<p>DELETE /user/{user_name}/secrets/{secret_id}</p>
</blockquote>
</li>
<li><p>获取秘密列表</p>
<blockquote>
<p>GET /secrets</p>
</blockquote>
</li>
<li><p>获取秘密评论列表</p>
<blockquote>
<p>GET   /secrets/{secret_id}/comments</p>
</blockquote>
</li>
<li><p>评论秘密</p>
<blockquote>
<p>POST /secrets/{secret_id}/comments</p>
</blockquote>
</li>
</ul>
<p>上面的api节点稍难实现的应该是鉴权，毕竟看这篇博文的同学肯定也是第一次构建RESTful接口，鉴权的过程和原理都不太清楚而其他节点实现逻辑基本上和一般的网站后台无异，只是返回的数据格式稍有变化，但是要实现鉴权首先得注册，所以我就拿这两个接口作为演示</p>
<h2 id="创建好api节点路由"><a href="#创建好api节点路由" class="headerlink" title="创建好api节点路由"></a>创建好api节点路由</h2><p>我们同时在routes.php下进行RESTful节点路由定义但与平时采用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Route::get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World'</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>定义节点不同，我们使用dingo封装上的路由来定义RESTful api节点</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$api = app(<span class="string">'Dingo\Api\Routing\Router'</span>);</span><br><span class="line">$api-&gt;version(<span class="string">'v1'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($api)</span> </span>&#123;</span><br><span class="line">    $api-&gt;get(<span class="string">'/hello/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如上我们已经定义好了一个get方法节点，在匿名函数的嵌套中我们依次定义了节点及其实现</p>
<p>其中 $api-&gt;version方法定义了接口的版本号，env文件里面我们默认设置是v1</p>
<p>我们在homestead里面run起来，这个接口已经是可以访问的了</p>
<p>我们用<a href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop" target="_blank" rel="noopener">postman</a>测试一下已经是可以访问的了，至于为什么一个简单的接口耗费了400ms，一方面是虚拟机共享目录，另一方面我为了测试开启了xdebug所以性能损耗很大</p>
<p><a href="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/hello-api-test.jpg" target="_blank" rel="noopener"><img src="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/hello-api-test.jpg" alt="restful laravel hello api"></a></p>
<p>可能你会说这和<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Route::get(<span class="string">'/hello'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'hello'</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>有什么区别，确实在这里还看不出dingo的优势，我们带着好奇心继续探索</p>
<p>根据dingo上wiki文档我们发现dingo完全是兼容Route常见写法的</p>
<p>我贴几段示例代码就不一一测试了</p>
<p>我们同样可以在节点定义中使用中间件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$api-&gt;version(<span class="string">'v1'</span>, [<span class="string">'middleware'</span>=&gt;<span class="string">'foo'</span>],<span class="function"><span class="keyword">function</span><span class="params">($api)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>group也是可以使用的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$api-&gt;version(<span class="string">'v1'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($api)</span> </span>&#123;</span><br><span class="line">        $api-&gt;group([<span class="string">'middleware'</span> =&gt; <span class="string">'foo'</span>], <span class="function"><span class="keyword">function</span> <span class="params">($api)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Endpoints registered here will have the "foo" middleware applied.</span></span><br><span class="line">        &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="实现一个注册结点"><a href="#实现一个注册结点" class="headerlink" title="实现一个注册结点"></a>实现一个注册结点</h2><p>当然如果仅能使用闭包函数来实现逻辑就太惨了，我们弄个controller来看看<br><code>php artisan make:controller Api/V1/UserController</code><br>我们把所有api接口相关的Controller都放到Api目录下的V1目录中<br>将hello写到index方法里面来，UserController的命名空间太长了，为了长远打算我们使用namespcace统一命名空间<br>修改后routes.php如下<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$api = app(<span class="string">'Dingo\Api\Routing\Router'</span>);</span><br><span class="line">$api-&gt;version(<span class="string">'v1'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($api)</span> </span>&#123;</span><br><span class="line">    $api-&gt;group([<span class="string">'namespace'</span> =&gt; <span class="string">'App\Http\Controllers\Api\V1'</span>], <span class="function"><span class="keyword">function</span> <span class="params">($api)</span> </span>&#123;</span><br><span class="line">        $api-&gt;get(<span class="string">'/hello/'</span>, <span class="string">'UserController@index'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>看上去已经有那么点意思了，小试牛刀后我们正式着手接口设计，首先我们要实现注册接口<br>至于数据库我就偷懒使用自带的migration来实现了,为了方便我稍稍做了修改<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Schema::create(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint $table)</span> </span>&#123;</span><br><span class="line">    $table-&gt;increments(<span class="string">'id'</span>);</span><br><span class="line">    $table-&gt;string(<span class="string">'name'</span>)-&gt;unique();;</span><br><span class="line">    $table-&gt;string(<span class="string">'password'</span>, <span class="number">60</span>);</span><br><span class="line">    $table-&gt;rememberToken();</span><br><span class="line">    $table-&gt;timestamps();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>创建好了注册节点<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$api-&gt;post(<span class="string">'/users/&#123;user_name&#125;/register'</span>,<span class="string">'UserController@register'</span>);</span><br></pre></td></tr></table></figure></p>
<p>实现具体逻辑前我们对User Model稍稍修改一下，删去了不用的email相关字段</p>
<p>回到UserController，我们实现最基本的注册逻辑</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>\<span class="title">V1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Dingo</span>\<span class="title">Api</span>\<span class="title">Routing</span>\<span class="title">Helpers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">use</span> <span class="title">Helpers</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">($user_name, Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (User::where(<span class="string">'name'</span>, $user_name)-&gt;count() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;response-&gt;errorBadRequest(<span class="string">'该用户已经存在'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!preg_match(<span class="string">'/^[a-z0-9]&#123;6,15&#125;$/'</span>, $user_name)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;response-&gt;errorBadRequest(<span class="string">'用户名由6-15位小写字母和数字组成'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $password = $request-&gt;json(<span class="string">'password'</span>);</span><br><span class="line">        $user = <span class="keyword">new</span> User();</span><br><span class="line">        $user-&gt;name = $user_name;</span><br><span class="line">        $user-&gt;password = bcrypt($password);</span><br><span class="line">        $user-&gt;save();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;created(<span class="string">"/users/"</span> . $user_name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为是演示程序，我只做了很简单的数据校验，如果用户存在的或不符合用户名规范都使用dingo的helper链式调用errorBadRequest返回400相应码告诉客户端这是个错误的请求</p>
<p>我们注册一个用户试试</p>
<p><a href="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/register1.jpg" target="_blank" rel="noopener"><img src="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/register1.jpg" alt="注册失败"></a></p>
<p>因为我的dingo开启了debug模式所以返回的json包含了debug字段</p>
<p>我们把H换成小写</p>
<p><a href="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/register2.jpg" target="_blank" rel="noopener"><img src="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/register2.jpg" alt="注册成功"></a></p>
<p>成功注册用户，返回201 created相应码并在header出现了新建资源的location</p>
<h2 id="鉴权"><a href="#鉴权" class="headerlink" title="鉴权"></a>鉴权</h2><p>简单实现了注册逻辑后我们该实现鉴权的逻辑</p>
<p>关于RESTful的鉴权方式常见的有以下几种</p>
<h3 id="HTTP-basic-authentication"><a href="#HTTP-basic-authentication" class="headerlink" title="HTTP basic authentication"></a>HTTP basic authentication</h3><p>这种鉴权方式最常见的地方是登录无线路由器配置时弹出的帐号登录对话框，其密码仅仅通过base64简单编码后明文传输，如果不使用https加密传输极其不安全，不建议</p>
<h3 id="Custom-自定义"><a href="#Custom-自定义" class="headerlink" title="Custom 自定义"></a>Custom 自定义</h3><p>顾名思义自己定义一套自己的授权方式，客户端和服务端通过此方式交互</p>
<h3 id="OAuth-2-0"><a href="#OAuth-2-0" class="headerlink" title="OAuth 2.0"></a>OAuth 2.0</h3><p>关于OAuth2.0可以主要参考<a href="http://www.rfcreader.com/#rfc6749" target="_blank" rel="noopener">rfc6749</a>，Oauth2.0的workflow可以由下图表示</p>
<p><img src="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/Oauth2.0workflow.jpg" alt="Oauth2.0 workflow"></p>
<p>Oauth2.0 简单的说就是一个关于授权的标准，在世界范围广泛应用</p>
<p>在整个授权过程中至少有三个参与者参与：</p>
<p>Client即被授予权限的客户，</p>
<p>Resouce Owner即资源所有者，</p>
<p>Authorization Server授权服务器，</p>
<p>Resource Server 资源服务器，可以和Resource Owner为同一服务器</p>
<p>我们以常见的论坛使用QQ号登录为例</p>
<p>当我们进入某个论坛又不想注册帐号的时候我们会发现大多数论坛有使用QQ号登录的选项，这个过程就是一个Oauth的过程，</p>
<p>我们假设用户小王想查看某摄影论坛的高清图片，但是小王不想注册帐号便使用QQ号登录，整个过程与workflow的对应如下</p>
<p>A:点击登录按钮请求登录的过程</p>
<p>B:服务器接受登录请求返回登录框</p>
<p>C:输入帐号密码点击登录</p>
<p>D:帐号密码无误，返回Access Token</p>
<p>E:论坛带上Access Token向腾讯服务器请求用户头像，用户昵称等受保护资源</p>
<p>F:服务器验证Access Token是否有效，如果无误返回受保护的资源</p>
<p>这个OAuth授权到此结束</p>
<p>可以说OAuth主要应用在web程序为第三方应用短期授权上，为第三方应用访问保护资源提供了可靠安全的鉴权方式</p>
<p>依我的经验大多数服务器对自己应用的授权可以说是OAuth的精简版</p>
<p>即砍掉A B过程</p>
<h3 id="参考资料-secure-your-rest-api-right-way"><a href="#参考资料-secure-your-rest-api-right-way" class="headerlink" title="参考资料 secure-your-rest-api-right-way"></a>参考资料 <a href="https://stormpath.com/blog/secure-your-rest-api-right-way/" target="_blank" rel="noopener">secure-your-rest-api-right-way</a></h3><h2 id="关于JWT"><a href="#关于JWT" class="headerlink" title="关于JWT"></a>关于JWT</h2><p>现在我们要实现C D 来完成授权，“权“体现在哪呢，当然是Access Token上，OAuth并没有强制规定token如何生成采用何种算法 ，但是比较通用的做法是采用<a href="https://jwt.io/introduction/" target="_blank" rel="noopener">JWT</a>(json web token，参考<a href="https://tools.ietf.org/html/rfc7519" target="_blank" rel="noopener">rfc7519</a>)</p>
<p>我们先来看看jwt长什么样子，嗯，就是下面这一长串的符号<br><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIyOTEwMjYiLCJpc3MiOiJodHRwOlwvXC8xMzkuMTI5LjkzLjU4XC9hcGlcL3VzZXJcLzI5MTAyNlwvYXV0aCIsImlhdCI6MTQ1NjA2OTQ4MSwiZXhwIjoxNDU2Njc0MjgxLCJuYmYiOjE0NTYwNjk0ODEsImp0aSI6ImQ2YzIwYTUzNTg5OTJlN2M1ZmVjYWI0ODFhOTRlZDQwIn0.V0ILcwzI47AkoEccMnxo3-mnR4MdrVlyFaZy_t78nys</code><br>稍微仔细看大家可以找到3个  .   符号，这个3个.将jwt分成了3个部分</p>
<ul>
<li>Header</li>
<li>Payload</li>
<li>Signature<br>分别用base64编码后拼接构成了jwt</li>
</ul>
<p>Header主要阐述了token类型和加密算法<br><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"typ"</span>: <span class="string">"JWT"</span>,</span><br><span class="line">    <span class="attr">"alg"</span>: <span class="string">"HS256"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>jwt通常使用HMACSHA256或者RSA公私钥对加解密<br>Payload段主要存储事先定义好的声明（claims），但是有几个字段是jwt推荐保留的，他们分别是</p>
<ul>
<li><p>iss (issuer)</p>
</li>
<li><p>exp(expiration time)</p>
</li>
<li><p>sub(subject)</p>
</li>
<li><p>aud(audience)</p>
</li>
</ul>
<p>其他的可以自定义</p>
<p>最后是Signature<br>签名的算法如下，以HMAC算法为例<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">base64UrlEncode(header) + &quot;.&quot; +</span><br><span class="line">base64UrlEncode(payload),</span><br><span class="line">secret)</span><br></pre></td></tr></table></figure></p>
<p>一个JWT就这样生成了<br>至于我们使用jwt的workflow就是我刚才说的精简版的Oauth<br><a href="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/jwt-diagram.png" target="_blank" rel="noopener"><img src="https://nznasujhj.qnssl.com/wp-content/uploads/2016/02/jwt-diagram.png" alt="jwt-diagram"></a></p>
<h2 id="在Dingo中集成JWT"><a href="#在Dingo中集成JWT" class="headerlink" title="在Dingo中集成JWT"></a>在Dingo中集成JWT</h2><p>扯了一堆概念，现在我们要着手实现JWT，我们当然不用重新造轮子，Dingo兼容的JWT实现我们将它配置好（<a href="https://github.com/tymondesigns/jwt-auth" target="_blank" rel="noopener">jwt-auth</a>）集成进去，具体方法参加项目<a href="https://github.com/tymondesigns/jwt-auth/wiki/Installation" target="_blank" rel="noopener">wiki</a></p>
<p>我们在config/api.php配置文件中加上</p>
<p><pre><code>&#39;jwt&#39; =&gt; &#39;Dingo\Api\Auth\Provider\JWT&#39;</code></pre><br>或者在ServiceProvider或bootstrap文件中加入</p>
<p><pre><code>app(&#39;Dingo\Api\Auth\Auth&#39;)-&gt;extend(&#39;jwt&#39;, function ($app) {
        return new Dingo\Api\Auth\Provider\JWT($app[&#39;Tymon\JWTAuth\JWTAuth&#39;]);
});</code></pre><br>修改一下routes.php<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$api = app(<span class="string">'Dingo\Api\Routing\Router'</span>);</span><br><span class="line">$api-&gt;version(<span class="string">'v1'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($api)</span> </span>&#123;</span><br><span class="line">    $api-&gt;group([<span class="string">'namespace'</span> =&gt; <span class="string">'App\Http\Controllers\Api\V1'</span>], <span class="function"><span class="keyword">function</span> <span class="params">($api)</span> </span>&#123;</span><br><span class="line">        $api-&gt;post(<span class="string">'/users/&#123;user_name&#125;/register'</span>, <span class="string">'UserController@register'</span>);</span><br><span class="line">        $api-&gt;post(<span class="string">'/users/&#123;user_name&#125;/auth'</span>,<span class="string">'UserController@auth'</span>);</span><br><span class="line">        $api-&gt;group([<span class="string">'middleware'</span> =&gt; <span class="string">'api.auth'</span>], <span class="function"><span class="keyword">function</span> <span class="params">($api)</span> </span>&#123;</span><br><span class="line">            $api-&gt;get(<span class="string">'/users/&#123;user_name&#125;/'</span>, <span class="string">'UserController@showUserInfo'</span>);</span><br><span class="line">            $api-&gt;get(<span class="string">'/users/&#123;user_name&#125;/secrets'</span>,<span class="string">'UserController@showUserSecrets'</span>);</span><br><span class="line">            $api-&gt;post(<span class="string">'/users/&#123;user_name&#125;/secrets'</span>,<span class="string">'UserController@postSecret'</span>);</span><br><span class="line">            $api-&gt;get(<span class="string">'/secrets/&#123;secret_id&#125;/comments'</span>,<span class="string">'SecretController@showSecretComments'</span>);</span><br><span class="line">            $api-&gt;post(<span class="string">'/secrets/&#123;secret_id&#125;/comments'</span>,<span class="string">'SecretController@postSecretComment'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>篇幅原因，我们主要实现一下鉴权的逻辑，大家可以抽空实现剩下的业务逻辑</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">(Request $request, $user_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $password = $request-&gt;json(<span class="string">'password'</span>);</span><br><span class="line">    $credentials = [<span class="string">'password'</span> =&gt; $password, <span class="string">'name'</span> =&gt; $user_name];</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!$access_token = JWTAuth::attempt($credentials)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;response-&gt;errorUnauthorized(<span class="string">'帐号或密码错误'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;array([<span class="string">'access_token'</span> =&gt; $access_token]);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JWTException $e) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;response-&gt;errorInternal(<span class="string">'暂时无法生成token'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>credentials即鉴权所需的凭证在这里就是一个数组键值对，对应我们的数据库模型就是用户名和密码，键值一定是和数据库相应字段一一对应的<br>jwt-auth库会自动的通过数据库校验该条记录是否存在<br>如果存在则返回对应的access_token，至于返回格式客户端和服务端事先商量好<br>我事先在数据库中插入了一条用户记录，我们直接通过curl 来试试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X POST <span class="string">"http://localhost:8000/api/users/helloworld/auth"</span> -d <span class="string">'&#123;"password":"helloworld"&#125;</span></span><br></pre></td></tr></table></figure>
<p>返回如下<br><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"access_token"</span>:<span class="string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjEsImlzcyI6Imh0dHA6XC9cL2xvY2FsaG9zdDo4MDAwXC9hcGlcL3VzZXJzXC9oZWxsb3dvcmxkXC9hdXRoIiwiaWF0IjoxNDU3MjQ0NzIyLCJleHAiOjE0NTcyNDgzMjIsIm5iZiI6MTQ1NzI0NDcyMiwianRpIjoiZDBhZjA4ZmFjZjJmMDQ2ZDRmNTY4OWI2MzgyZWRiNTMifQ.m20CfmrpajEGcRqD-SIDyqkDe-95M3WUyorTEYT-360"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>成功获取access_token，如果我们稍微修改一下密码呢</p>
<p>拿到了401响应码和对应的message，由于debug信息很长我就不复制了</p>
<p>接下来，我们要通过token访问其他在api.auth中间件保护下的接口</p>
<p>token 通过http header Authorization: Bearer 字段传送到服务器端</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -X GET -H <span class="string">"Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjEsImlzcyI6Imh0dHA6XC9cL2xvY2FsaG9zdDo4MDAwXC9hcGlcL3VzZXJzXC9oZWxsb3dvcmxkXC9hdXRoIiwiaWF0IjoxNDU3MjQ0NzIyLCJleHAiOjE0NTcyNDgzMjIsIm5iZiI6MTQ1NzI0NDcyMiwianRpIjoiZDBhZjA4ZmFjZjJmMDQ2ZDRmNTY4OWI2MzgyZWRiNTMifQ.m20CfmrpajEGcRqD-SIDyqkDe-95M3WUyorTEYT-360 "</span> -i  <span class="string">"http://localhost:8000/api/users/helloworld/"</span></span><br></pre></td></tr></table></figure>
<p>我简单的返回了该条用户的json<br><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"user"</span>:&#123;<span class="attr">"id"</span>:<span class="number">1</span>,<span class="attr">"name"</span>:<span class="string">"helloworld"</span>,<span class="attr">"created_at"</span>:<span class="string">"2016-02-27 05:51:17"</span>,<span class="attr">"updated_at"</span>:<span class="string">"2016-02-27 05:51:17"</span>&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>之后需要受保护的接口都需要带上token才能访问<br>暂时先写到这，dingo还有许多实用的功能，以后有空再来补充</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/laravel/" rel="tag"># laravel</a>
          
            <a href="/tags/php/" rel="tag"># php</a>
          
            <a href="/tags/auth/" rel="tag"># auth</a>
          
            <a href="/tags/dingo/" rel="tag"># dingo</a>
          
            <a href="/tags/jwt/" rel="tag"># jwt</a>
          
            <a href="/tags/RESTful/" rel="tag"># RESTful</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/01/19/laravel-aes-256-cbc-algo-android-implement/" rel="next" title="在android端实现与laravel兼容的AES-256-CBC加密算法">
                <i class="fa fa-chevron-left"></i> 在android端实现与laravel兼容的AES-256-CBC加密算法
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/03/13/install-3-5-inch-screen-on-raspbian-jessie/" rel="prev" title="树莓派raspbian-jessie安装3.5英寸lcd屏幕">
                树莓派raspbian-jessie安装3.5英寸lcd屏幕 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">coderwen</p>
              <p class="site-description motion-element" itemprop="description">闷声学技术，比西方记者快，比华莱士高</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">47</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">86</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置"><span class="nav-number">2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设计RESTful接口"><span class="nav-number">3.</span> <span class="nav-text">设计RESTful接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建好api节点路由"><span class="nav-number">4.</span> <span class="nav-text">创建好api节点路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现一个注册结点"><span class="nav-number">5.</span> <span class="nav-text">实现一个注册结点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#鉴权"><span class="nav-number">6.</span> <span class="nav-text">鉴权</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP-basic-authentication"><span class="nav-number">6.1.</span> <span class="nav-text">HTTP basic authentication</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Custom-自定义"><span class="nav-number">6.2.</span> <span class="nav-text">Custom 自定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OAuth-2-0"><span class="nav-number">6.3.</span> <span class="nav-text">OAuth 2.0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考资料-secure-your-rest-api-right-way"><span class="nav-number">6.4.</span> <span class="nav-text">参考资料 secure-your-rest-api-right-way</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关于JWT"><span class="nav-number">7.</span> <span class="nav-text">关于JWT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在Dingo中集成JWT"><span class="nav-number">8.</span> <span class="nav-text">在Dingo中集成JWT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试"><span class="nav-number">9.</span> <span class="nav-text">测试</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">coderwen</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
